#!/bin/bash

DIR="$(dirname "$0")"
. "${DIR}/config"


# deply service to all designated regions
for SERVICE_REGION in "${SERVICE_REGIONS[@]}"
do
	echo "deploying to ${SERVICE_REGION}"
  gcloud run deploy $SERVICE_NAME \
    --image "gcr.io/cloudylabs-public/${SERVICE_NAME}:${SERVICE_IMAGE_VERSION}" \
    --allow-unauthenticated \
    --platform managed \
    --timeout 15m \
    --region $SERVICE_REGION \
    --labels "region=${SERVICE_REGION}" \
    --set-env-vars "DB_PATH=projects/${PROJECT}/instances/${SERVICE_NAME}/databases/echo" \
    --service-account "${SERVICE_NAME}@${PROJECT}.iam.gserviceaccount.com"

  # bind the serivice account to the depliyed service, in all regions
	gcloud beta run services add-iam-policy-binding $SERVICE_NAME \
	  --platform managed \
		--region $SERVICE_REGION \
		--member "serviceAccount:${SERVICE_NAME}@${PROJECT}.iam.gserviceaccount.com" \
		--role roles/run.invoker

done